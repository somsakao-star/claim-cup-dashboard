import React, { useState, useMemo, useEffect } from 'react';
import {
  Home, Settings, Menu, X, DollarSign, Activity,
  FileJson, Filter, LayoutGrid, Clock, Trophy, Syringe, Baby,
  Flower, Scan, HeartPulse, Monitor, Moon, Sun, Database,
  ChevronDown, Search, TrendingUp, ArrowUpRight, User, Stethoscope
} from 'lucide-react';
import { initializeApp, getApps, getApp } from 'firebase/app';
import {
  getAuth,
  signInAnonymously,
  onAuthStateChanged
} from 'firebase/auth';
import {
  getFirestore,
  collection,
  query,
  onSnapshot,
  collectionGroup
} from 'firebase/firestore';

// --- 1. CONFIGURATION ---
const USE_MOCK_DATA = false; // false = ใช้ข้อมูลจริงจาก Firebase

const firebaseConfig = {
  apiKey: "AIzaSyDGw6BdVP6zucoHm9fXKkR3sVpKV11xbn4",
  authDomain: "claim-cup-sankhong.firebaseapp.com",
  projectId: "claim-cup-sankhong",
  storageBucket: "claim-cup-sankhong.firebasestorage.app",
  messagingSenderId: "163329201931",
  appId: "1:163329201931:web:312e2d94a2dbc297b5340e"
};

// --- 2. MOCK DATA GENERATOR ---
const generateMockClaims = () => {
  const claims = [];
  const platforms = ['ktb', 'moph', 'eclaim', 'thai', 'physical', 'ntip'];
  const hcodes = ["05954", "05957", "05959", "05956", "05962"];
  const services = {
    ktb: ['ฉีดวัคซีนไข้หวัดใหญ่', 'เยี่ยมบ้าน', 'ตรวจคัดกรองเบาหวาน'],
    moph: ['OPPP Individual', 'ANC', 'Post-natal Care'],
    eclaim: ['ผู้ป่วยนอก (OPD)', 'ทันตกรรม', 'หัตถการฉุกเฉิน'],
    thai: ['นวดประคบ', 'อบสมุนไพร', 'จ่ายยาสมุนไพร'],
    physical: ['กายภาพบำบัด', 'ฟื้นฟูสมรรถภาพ'],
    ntip: ['ตรวจสุขภาพสิทธิข้าราชการ']
  };

  for (let i = 0; i < 300; i++) {
    const platform = platforms[Math.floor(Math.random() * platforms.length)];
    const serviceList = services[platform];
    const amount = Math.floor(Math.random() * 5000) + 500;
    const year = Math.random() > 0.4 ? "2569" : "2568";
    
    claims.push({
      id: `mock-${i}`,
      hcode: hcodes[Math.floor(Math.random() * hcodes.length)],
      fiscal_year: year,
      month: Math.floor(Math.random() * 12) + 1,
      platform: platform,
      service_item: serviceList[Math.floor(Math.random() * serviceList.length)],
      amount: amount,
      status: 'อนุมัติแล้ว'
    });
  }
  return claims;
};

const mockClaimsData = generateMockClaims();

// --- 3. FIREBASE INIT ---
let db = null;
let auth = null;
let isFirebaseReady = false;

try {
  if (!USE_MOCK_DATA && firebaseConfig.apiKey) {
    const app = !getApps().length ? initializeApp(firebaseConfig) : getApp();
    auth = getAuth(app);
    db = getFirestore(app);
    isFirebaseReady = true;
  }
} catch (e) {
  console.error("Firebase init failed", e);
}

// --- 4. CONSTANTS ---
const hospitalList = [
  { code: "all", name: "หน่วยงาน" },
  { code: "05954", name: "รพ.สต.บ้านสันโค้ง" },
  { code: "05957", name: "รพ.สต.บ้านกอสะเรียม" },
  { code: "05959", name: "รพ.สต.บ้านแม่ผาแหน" },
  { code: "05956", name: "รพ.สต.บ้านป่าตาล" },
  { code: "05962", name: "รพ.สต.บ้านต้นเปา" },
];

const funds = [
  { code: "all", name: "Platform" },
  { code: "ktb", name: "KTB" },
  { code: "moph", name: "Moph-Claim" },
  { code: "eclaim", name: "E-Claim" },
  { code: "thai", name: "แพทย์แผนไทย" },
  { code: "physical", name: "กายภาพ" },
  { code: "ntip", name: "NTIP" },
];

const years = ["2569", "2568"];
const months = ["เดือน", "มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];

const monthMapping = {
  "มกราคม": "1", "กุมภาพันธ์": "2", "มีนาคม": "3", "เมษายน": "4", "พฤษภาคม": "5", "มิถุนายน": "6",
  "กรกฎาคม": "7", "สิงหาคม": "8", "กันยายน": "9", "ตุลาคม": "10", "พฤศจิกายน": "11", "ธันวาคม": "12"
};

// --- 5. LOGIC FUNCTIONS ---
function calculateStats(claims, hCode, year, month, fund) {
  const filtered = claims.filter(c => {
    const dataHcode = c.hcode || "";
    const dataYear = c.fiscal_year ? String(c.fiscal_year) : "";
    const dataMonth = c.month ? String(c.month) : "";
    const dataPlatform = c.platform ? c.platform.toLowerCase() : "";

    const matchH = hCode === 'all' || dataHcode === hCode;
    const matchY = year === 'all' || dataYear === String(year);
    const targetMonthNum = monthMapping[month];
    const matchM = month === 'เดือน' || dataMonth === targetMonthNum;
    const matchF = fund === 'all' || dataPlatform === fund;

    return matchH && matchY && matchM && matchF;
  });

  const fundTotals = { ktb: 0, moph: 0, eclaim: 0, thai: 0, physical: 0, ntip: 0 };
  const fundItems = { ktb: {}, moph: {}, eclaim: {}, thai: {}, physical: {}, ntip: {} };
  
  filtered.forEach(c => {
    const platformKey = c.platform ? c.platform.toLowerCase() : 'other';
    if (fundTotals[platformKey] !== undefined) {
      let amountStr = String(c.amount || 0).replace(/,/g, '');
      const amountVal = parseFloat(amountStr) || 0;
      fundTotals[platformKey] += amountVal;
      
      const serviceName = c.service_item || "ไม่ระบุ";
      if (!fundItems[platformKey][serviceName]) fundItems[platformKey][serviceName] = 0;
      fundItems[platformKey][serviceName] += amountVal;
    }
  });

  const details = {};
  Object.keys(fundItems).forEach(k => {
    details[k] = Object.entries(fundItems[k])
      .map(([name, val]) => ({ name, value: val }))
      .sort((a, b) => b.value - a.value);
  });

  const total = Object.values(fundTotals).reduce((a, b) => a + b, 0);

  const fundPieData = Object.entries(fundTotals).map(([k, v]) => {
    const colorMap = { ktb: "#2dd4bf", moph: "#fbbf24", eclaim: "#a78bfa", thai: "#34d399", physical: "#f472b6", ntip: "#fb923c" };
    const fName = funds.find(f => f.code === k)?.name || k;
    return { label: fName, value: v, color: colorMap[k] || "#94a3b8" };
  }).filter(x => x.value > 0).map(x => ({ ...x, percent: total > 0 ? Math.round((x.value / total) * 100) : 0})).sort((a, b) => b.value - a.value);

  return { total, totals: fundTotals, details, fundPieData };
}

function calculateTrendData(claims, hCode, fund) {
    const monthlyData = { "2568": Array(12).fill(0), "2569": Array(12).fill(0) };
    
    claims.forEach(c => {
        const dataHcode = c.hcode || "";
        const dataYear = c.fiscal_year ? String(c.fiscal_year) : "";
        const dataMonth = c.month ? parseInt(c.month) : 0;
        const platformKey = c.platform ? c.platform.toLowerCase() : '';

        if ((hCode === 'all' || dataHcode === hCode) && 
            (fund === 'all' || platformKey === fund)) {
            if (monthlyData[dataYear] && dataMonth >= 1 && dataMonth <= 12) {
                let amountStr = String(c.amount || 0).replace(/,/g, '');
                monthlyData[dataYear][dataMonth - 1] += parseFloat(amountStr) || 0;
            }
        }
    });
    return monthlyData;
}

// --- 6. UI COMPONENTS ---

const SidebarItem = ({ icon: Icon, text, active, onClick }) => (
  <button 
    onClick={onClick}
    className={`w-full flex items-center space-x-3 lg:space-x-0 lg:justify-center px-4 lg:px-2 py-3 rounded-2xl transition-all duration-200 group ${
      active 
        ? 'bg-teal-50 text-teal-700 font-bold shadow-sm border border-teal-100' 
        : 'text-slate-500 hover:bg-slate-50 hover:text-teal-600'
    }`}
    title={text}
  >
    <Icon size={22} className={active ? 'text-teal-600' : 'text-slate-400 group-hover:text-teal-500'} />
    <span className="truncate lg:hidden">{text}</span>
    {active && <div className="ml-auto w-1.5 h-1.5 rounded-full bg-teal-500 lg:hidden" />}
  </button>
);

const SimplePieChart = ({ data }) => {
  if (!data || data.length === 0) return <div className="text-xs text-slate-400">ไม่มีข้อมูล</div>;
  
  const gradientParts = data.map((item, index, arr) => {
    const start = arr.slice(0, index).reduce((acc, curr) => acc + curr.percent, 0);
    const end = start + item.percent;
    const safeEnd = end < start ? start : end; 
    return `${item.color} ${start}% ${safeEnd}%`;
  });

  const gradientString = gradientParts.length > 0 ? `conic-gradient(${gradientParts.join(', ')})` : 'conic-gradient(#e2e8f0 0% 100%)';

  return (
    <div className="flex items-center space-x-6">
      {/* Chart - Donut Style (Clean) */}
      <div className="relative w-32 h-32 rounded-full shrink-0 shadow-sm" style={{ background: gradientString }}>
        {/* Inner Circle - Matches Light BG */}
        <div className="absolute inset-5 bg-white rounded-full flex flex-col items-center justify-center z-10 shadow-inner">
           <span className="text-[10px] text-slate-400 font-medium">สูงสุด</span>
           <span className="text-xl font-bold text-slate-700">{data[0]?.percent}%</span>
        </div>
      </div>
      
      {/* Legend List */}
      <div className="flex flex-col space-y-2">
          {data.map((item, idx) => (
              <div key={idx} className="flex items-center text-xs text-slate-600">
                  <span className="w-3 h-3 rounded-full mr-2 shrink-0 shadow-sm" style={{ backgroundColor: item.color }}></span>
                  <span className="flex-1 truncate w-24 font-medium" title={item.label}>{item.label}</span>
                  <span className="font-bold ml-3 w-8 text-right text-slate-700">{item.percent}%</span>
              </div>
          ))}
      </div>
    </div>
  );
};

// Medical Style Line Chart (Restored to Area Spline for Light Theme)
const MedicalLineChart = ({ data2568, data2569 }) => {
    const maxVal = Math.max(...data2568, ...data2569, 1000) * 1.1; 
    const monthsShort = ["ต.ค.", "พ.ย.", "ธ.ค.", "ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย."]; 
    
    const shiftData = (arr) => [...arr.slice(9), ...arr.slice(0, 9)];
    const d68 = shiftData(data2568);
    const d69 = shiftData(data2569);

    const getCoord = (val, idx) => ({
        x: (idx / 11) * 100,
        y: 100 - ((val / maxVal) * 75)
    });

    const getSplinePath = (data, isArea = false) => {
        if (data.length === 0) return "";
        const points = data.map((val, idx) => {
            const {x, y} = getCoord(val, idx);
            return [x, y];
        });
        const controlPoint = (current, previous, next, reverse) => {
            const p = previous || current;
            const n = next || current;
            const smoothing = 0.2;
            const o = line(p, n);
            const angle = o.angle + (reverse ? Math.PI : 0);
            const length = o.length * smoothing;
            const x = current[0] + Math.cos(angle) * length;
            const y = current[1] + Math.sin(angle) * length;
            return [x, y];
        };
        const line = (pointA, pointB) => {
            const lengthX = pointB[0] - pointA[0];
            const lengthY = pointB[1] - pointA[1];
            return { length: Math.sqrt(Math.pow(lengthX, 2) + Math.pow(lengthY, 2)), angle: Math.atan2(lengthY, lengthX) };
        };
        const d = points.reduce((acc, point, i, a) => {
            if (i === 0) return `M ${point[0]},${point[1]}`;
            const [cpsX, cpsY] = controlPoint(a[i - 1], a[i - 2], point);
            const [cpeX, cpeY] = controlPoint(point, a[i - 1], a[i + 1], true);
            return `${acc} C ${cpsX},${cpsY} ${cpeX},${cpeY} ${point[0]},${point[1]}`;
        }, "");
        
        if (isArea) {
            return `${d} L 100,100 L 0,100 Z`;
        }
        return d;
    };

    const total2568 = d68.reduce((a,b)=>a+b,0);
    const total2569 = d69.reduce((a,b)=>a+b,0);

    return (
        <div className="w-full h-full flex flex-col select-none text-slate-700">
            <div className="flex items-center justify-around mb-8 px-4 bg-slate-50 py-3 rounded-xl border border-slate-100">
                <div className="text-center">
                    <div className="text-2xl font-bold tracking-tight mb-1 text-teal-600">{total2568.toLocaleString()}</div>
                    <div className="flex items-center justify-center space-x-2">
                         <span className="w-2.5 h-2.5 rounded-full bg-teal-400"></span>
                         <span className="text-xs text-slate-500 font-medium">ปีงบ 2568</span>
                    </div>
                </div>
                <div className="text-center">
                    <div className="text-2xl font-bold tracking-tight mb-1 text-sky-600">{total2569.toLocaleString()}</div>
                    <div className="flex items-center justify-center space-x-2">
                         <span className="w-2.5 h-2.5 rounded-full bg-sky-400"></span>
                         <span className="text-xs text-slate-500 font-medium">ปีงบ 2569</span>
                    </div>
                </div>
            </div>
            
            <div className="relative flex-1 w-full min-h-[220px]">
                 <div className="absolute inset-0 flex flex-col justify-between text-[10px] text-slate-400 pointer-events-none z-0">
                    {[100, 75, 50, 25, 0].map((p, i) => {
                        const val = maxVal * (p/100);
                        const valStr = val >= 1000 ? (val / 1000).toFixed(0) + 'k' : val.toFixed(0);
                        return (
                            <div key={i} className="border-b border-slate-100 w-full h-0 relative">
                                 <span className="absolute -top-2 -left-8 text-right w-7 opacity-70 font-mono tracking-tighter">
                                     {valStr}
                                 </span>
                            </div>
                        );
                    })}
                 </div>
                 
                 <svg viewBox="0 0 100 100" className="absolute inset-0 w-full h-full overflow-visible z-10" preserveAspectRatio="none">
                     <defs>
                         <linearGradient id="gradSky" x1="0%" y1="0%" x2="0%" y2="100%">
                             <stop offset="0%" style={{stopColor:"#38bdf8", stopOpacity:0.4}} />
                             <stop offset="100%" style={{stopColor:"#38bdf8", stopOpacity:0}} />
                         </linearGradient>
                         <linearGradient id="gradTeal" x1="0%" y1="0%" x2="0%" y2="100%">
                             <stop offset="0%" style={{stopColor:"#2dd4bf", stopOpacity:0.4}} />
                             <stop offset="100%" style={{stopColor:"#2dd4bf", stopOpacity:0}} />
                         </linearGradient>
                     </defs>

                     {/* 2568 (Teal) */}
                     <path d={getSplinePath(d68, true)} fill="url(#gradTeal)" />
                     <path d={getSplinePath(d68)} fill="none" stroke="#2dd4bf" strokeWidth="3" />

                     {/* 2569 (Sky) */}
                     <path d={getSplinePath(d69, true)} fill="url(#gradSky)" />
                     <path d={getSplinePath(d69)} fill="none" stroke="#38bdf8" strokeWidth="3" />
                 </svg>
            </div>
            
            <div className="flex justify-between mt-2 text-xs text-slate-400 px-1 font-medium">
                {monthsShort.map((m, i) => <span key={i} className="text-center w-6">{m}</span>)}
            </div>
        </div>
    );
};

// --- 7. MAIN APP ---

export default function App() {
  const [sidebarOpen, setSidebarOpen] = useState(false);
  const [activeMenu, setActiveMenu] = useState('ภาพรวม (Overview)');
  const [claims, setClaims] = useState([]);
  const [status, setStatus] = useState("Loading...");

  const [selectedYear, setSelectedYear] = useState('2569');
  const [selectedMonth, setSelectedMonth] = useState('เดือน');
  const [selectedOrgCode, setSelectedOrgCode] = useState('all');
  const [selectedFund, setSelectedFund] = useState('all');

  useEffect(() => {
    if (USE_MOCK_DATA) {
        setClaims(mockClaimsData);
        setStatus("Demo Mode");
    } else if (isFirebaseReady && auth) {
        setStatus("กำลังเชื่อมต่อ...");
        const initAuth = async () => {
            try {
                await signInAnonymously(auth);
            } catch (e) {
                console.error("Auth Error", e);
                setStatus("Auth Error");
            }
        };
        initAuth();

        const unsubscribeAuth = onAuthStateChanged(auth, (user) => {
            if (user) {
                setStatus("กำลังดึงข้อมูล...");
                try {
                    const cQuery = query(collectionGroup(db, 'claims'));
                    const unsubscribeSnapshot = onSnapshot(cQuery, (snapshot) => {
                        const items = [];
                        snapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));
                        setClaims(items);
                        setStatus("ออนไลน์");
                    }, (error) => {
                        console.error("Snapshot Error", error);
                        setStatus("เกิดข้อผิดพลาด");
                    });
                    return () => unsubscribeSnapshot();
                } catch (e) {
                    console.error("Query Error", e);
                    setStatus("Query Error");
                }
            } else {
                setStatus("รอการยืนยันตัวตน...");
            }
        });
        return () => unsubscribeAuth();
    }
  }, []);

  const currentData = useMemo(() => {
    return calculateStats(claims, selectedOrgCode, selectedYear, selectedMonth, selectedFund);
  }, [claims, selectedOrgCode, selectedYear, selectedMonth, selectedFund]);

  const trendData = useMemo(() => {
    return calculateTrendData(claims, selectedOrgCode, selectedFund);
  }, [claims, selectedOrgCode, selectedFund]);

  const topHospitals = useMemo(() => {
    const validHospitals = hospitalList.filter(h => h.code !== 'all');
    return validHospitals.map(h => {
      const hStats = calculateStats(claims, h.code, selectedYear, selectedMonth, selectedFund);
      return { ...h, value: hStats.total, name: h.name }; // Added name here
    }).sort((a, b) => b.value - a.value);
  }, [claims, selectedYear, selectedMonth, selectedFund]);

  // Platform Cards - Clean White Medical Style
  const platformCards = [
    { key: 'ktb', title: "KTB", icon: Syringe, color: "text-teal-600", bg: "bg-teal-50", border: "border-teal-100", items: currentData.details.ktb },
    { key: 'moph', title: "Moph-Claim", icon: Baby, color: "text-amber-500", bg: "bg-amber-50", border: "border-amber-100", items: currentData.details.moph },
    { key: 'eclaim', title: "E-Claim", icon: Monitor, color: "text-indigo-500", bg: "bg-indigo-50", border: "border-indigo-100", items: currentData.details.eclaim },
    { key: 'thai', title: "แพทย์แผนไทย", icon: Flower, color: "text-emerald-600", bg: "bg-emerald-50", border: "border-emerald-100", items: currentData.details.thai },
    { key: 'physical', title: "กายภาพบำบัด", icon: HeartPulse, color: "text-rose-500", bg: "bg-rose-50", border: "border-rose-100", items: currentData.details.physical },
    { key: 'ntip', title: "NTIP", icon: Scan, color: "text-sky-500", bg: "bg-sky-50", border: "border-sky-100", items: currentData.details.ntip }
  ];

  // Ranking Colors (Pastel/Medical)
  const rankColors = [
      "bg-amber-100 text-amber-700 border-amber-200", 
      "bg-slate-100 text-slate-700 border-slate-200",   
      "bg-orange-100 text-orange-700 border-orange-200", 
      "bg-teal-100 text-teal-700 border-teal-200",
      "bg-indigo-100 text-indigo-700 border-indigo-200",
      "bg-rose-100 text-rose-700 border-rose-200"
  ];

  // Get selected fund name
  const selectedFundName = useMemo(() => {
      if (selectedFund === 'all') return '';
      return `(${funds.find(f => f.code === selectedFund)?.name || selectedFund})`;
  }, [selectedFund]);

  // Get selected hospital name
  const selectedHospitalName = useMemo(() => {
      const h = hospitalList.find(h => h.code === selectedOrgCode);
      return h?.code === 'all' ? 'ทุกหน่วยงาน' : h?.name;
  }, [selectedOrgCode]);

  // Get selected platform name for Line Chart
  const selectedPlatformName = useMemo(() => {
      const f = funds.find(f => f.code === selectedFund);
      return f?.code === 'all' ? 'ทุก Platform' : f?.name;
  }, [selectedFund]);

  return (
    <>
    {/* Import Font Kanit */}
    <style>{`@import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap');`}</style>
    
    <div className="flex h-screen bg-[#F1F5F9] text-slate-600 font-['Kanit'] overflow-hidden">
        
        {/* Mobile Sidebar Overlay */}
        {sidebarOpen && (
          <div 
            className="fixed inset-0 bg-slate-900/20 z-20 lg:hidden backdrop-blur-sm transition-opacity" 
            onClick={() => setSidebarOpen(false)}
          />
        )}

        {/* Sidebar - Clean White */}
        <aside className={`fixed lg:static inset-y-0 left-0 z-30 w-64 lg:w-20 bg-white border-r border-slate-200 flex flex-col transform transition-transform duration-300 ease-in-out ${sidebarOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'} shadow-sm`}>
          <div className="p-4 flex items-center justify-between lg:justify-center">
              <div className="flex items-center space-x-3 lg:space-x-0">
                  <div className="w-10 h-10 rounded-xl bg-teal-600 flex items-center justify-center shadow-lg shadow-teal-200">
                      <Stethoscope className="text-white" size={20} />
                  </div>
                  <div className="lg:hidden">
                      <h1 className="text-base font-bold tracking-tight text-slate-800">ClaimCup</h1>
                      <p className="text-[10px] text-slate-500">Sankhong Dashboard</p>
                  </div>
              </div>
              <button onClick={() => setSidebarOpen(false)} className="lg:hidden text-slate-400 hover:text-slate-600">
                  <X size={24} />
              </button>
          </div>

          <nav className="flex-1 px-3 space-y-2 overflow-y-auto py-6">
            <SidebarItem icon={LayoutGrid} text="ภาพรวม" active={activeMenu === 'ภาพรวม (Overview)'} onClick={() => { setActiveMenu('ภาพรวม (Overview)'); setSidebarOpen(false); }} />
            <SidebarItem icon={FileJson} text="ข้อมูลเคลม" active={activeMenu === 'Claims'} onClick={() => { setActiveMenu('Claims'); setSidebarOpen(false); }} />
            <SidebarItem icon={Trophy} text="จัดอันดับ" active={activeMenu === 'Ranking'} onClick={() => { setActiveMenu('Ranking'); setSidebarOpen(false); }} />
            <div className="my-4 border-t border-slate-100 lg:hidden"></div>
            <SidebarItem icon={Settings} text="ตั้งค่า" active={activeMenu === 'Settings'} onClick={() => setActiveMenu('Settings')} />
          </nav>

          <div className="p-4 border-t border-slate-100">
               <div className="flex items-center space-x-3 lg:space-x-0 lg:justify-center p-2 rounded-xl">
                   <div className={`w-2.5 h-2.5 rounded-full ${USE_MOCK_DATA ? 'bg-amber-400' : 'bg-emerald-500'} ring-4 ring-slate-50`} />
                   <span className="text-xs font-medium text-slate-500 flex-1 truncate lg:hidden">{status}</span>
               </div>
          </div>
        </aside>

        {/* Main Content Area - Light Medical Theme */}
        <div className="flex-1 flex flex-col h-full overflow-hidden relative">
            {/* Mobile Header */}
            <header className="h-16 bg-white border-b border-slate-100 px-4 flex items-center justify-between lg:hidden z-10 sticky top-0">
                 <button onClick={() => setSidebarOpen(true)} className="p-2 -ml-2 rounded-lg text-slate-500 hover:bg-slate-50">
                    <Menu size={24} />
                </button>
                <span className="font-semibold text-slate-700">ภาพรวม (Overview)</span>
                <div className="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center">
                    <User size={16} className="text-slate-500" />
                </div>
            </header>

            <div className="flex-1 p-4 lg:p-8 overflow-auto custom-scrollbar">
                <div className="max-w-7xl mx-auto space-y-6">
                    
                    {/* Header & Filter Bar */}
                    <div className="bg-white rounded-2xl p-4 border border-slate-100 flex flex-col md:flex-row md:items-center justify-between gap-4 shadow-sm">
                        {/* Filters Group (Left) */}
                        <div className="flex flex-wrap gap-3 items-center justify-center md:justify-start w-full md:w-auto">
                            <Filter size={18} className="text-slate-400 mr-1 hidden md:block" />
                            
                            <select 
                                value={selectedYear} 
                                onChange={(e) => setSelectedYear(e.target.value)}
                                className="bg-slate-50 border border-slate-200 text-slate-600 text-sm rounded-lg px-3 py-2 focus:ring-2 focus:ring-teal-500 outline-none cursor-pointer hover:border-teal-300 transition-colors"
                            >
                                {years.map(y => <option key={y} value={y}>ปีงบ {y}</option>)}
                            </select>

                            <select 
                                value={selectedOrgCode} 
                                onChange={(e) => setSelectedOrgCode(e.target.value)}
                                className="bg-slate-50 border border-slate-200 text-slate-600 text-sm rounded-lg px-3 py-2 focus:ring-2 focus:ring-teal-500 outline-none cursor-pointer hover:border-teal-300 transition-colors"
                            >
                                {hospitalList.map(h => <option key={h.code} value={h.code}>{h.name}</option>)}
                            </select>

                            <select 
                                value={selectedFund} 
                                onChange={(e) => setSelectedFund(e.target.value)}
                                className="bg-slate-50 border border-slate-200 text-slate-600 text-sm rounded-lg px-3 py-2 focus:ring-2 focus:ring-teal-500 outline-none cursor-pointer hover:border-teal-300 transition-colors"
                            >
                                {funds.map(f => <option key={f.code} value={f.code}>{f.name}</option>)}
                            </select>

                            <select 
                                value={selectedMonth} 
                                onChange={(e) => setSelectedMonth(e.target.value)}
                                className="bg-slate-50 border border-slate-200 text-slate-600 text-sm rounded-lg px-3 py-2 focus:ring-2 focus:ring-teal-500 outline-none cursor-pointer hover:border-teal-300 transition-colors"
                            >
                                {months.map(m => <option key={m} value={m}>{m}</option>)}
                            </select>
                        </div>

                        {/* Logo Group (Right Side) - Medical Style */}
                        <div className="flex items-center gap-3 pl-4 border-l border-slate-100">
                            <div className="w-10 h-10 rounded-xl bg-gradient-to-tr from-teal-500 to-emerald-400 flex items-center justify-center shadow-md shadow-emerald-100">
                                <Activity className="text-white" size={24} strokeWidth={2.5} /> 
                            </div>
                            <div className="text-lg font-bold tracking-tight flex items-center gap-1.5 leading-none">
                                <span className="text-indigo-600">Claim</span>
                                <span className="text-teal-600">Cup</span>
                                <span className="text-emerald-500">สันโค้ง</span>
                            </div>
                        </div>
                    </div>

                    {/* Main Content Grid */}
                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
                        
                        {/* Top Full Width Hero - Medical Summary Card */}
                        <div className="lg:col-span-12">
                             <div className="bg-gradient-to-br from-[#E0F7FA] to-[#B2DFDB] border border-teal-100 rounded-2xl p-6 shadow-sm flex items-center justify-between relative overflow-hidden min-h-[180px]">
                                 <div className="absolute top-0 right-0 p-24 bg-white/20 blur-[80px] rounded-full transform translate-x-1/2 -translate-y-1/2 pointer-events-none"></div>
                                 <div className="z-10 flex-1">
                                     <div className="flex justify-between items-start mb-2 pr-0 sm:pr-4"> {/* Adjusted wrapper */}
                                         <div className="flex items-center space-x-2 text-teal-800 mb-2">
                                             <div className="bg-white/50 p-1.5 rounded-lg backdrop-blur-sm">
                                                <DollarSign size={20} className="text-teal-600" />
                                             </div>
                                             <span className="text-sm font-semibold opacity-80">สรุปยอดเงินเบิกชดเชยรวม</span>
                                         </div>
                                         
                                         {/* Online Status Light */}
                                         <div className="flex items-center gap-2 bg-white/60 pl-2 pr-3 py-1 rounded-full border border-white/60 shadow-sm backdrop-blur-md">
                                            <span className="relative flex h-2.5 w-2.5">
                                              <span className={`animate-ping absolute inline-flex h-full w-full rounded-full opacity-75 ${USE_MOCK_DATA ? 'bg-amber-400' : 'bg-emerald-500'}`}></span>
                                              <span className={`relative inline-flex rounded-full h-2.5 w-2.5 ${USE_MOCK_DATA ? 'bg-amber-500' : 'bg-emerald-500'}`}></span>
                                            </span>
                                            <span className={`text-[10px] font-bold tracking-wide uppercase ${USE_MOCK_DATA ? 'text-amber-700' : 'text-emerald-700'}`}>
                                                {USE_MOCK_DATA ? 'Demo' : 'Online'}
                                            </span>
                                         </div>
                                     </div>
                                     
                                     <div className="text-5xl font-bold tracking-tight mb-3 text-teal-900">
                                         {currentData.total.toLocaleString()}
                                         <span className="text-lg text-teal-700 font-medium ml-2">บาท</span>
                                     </div>
                                     <div className="text-xs font-medium text-teal-700 bg-white/40 border border-white/50 inline-block px-3 py-1 rounded-full backdrop-blur-sm">
                                         ข้อมูลปีงบ {selectedYear}
                                     </div>
                                 </div>
                                 <div className="z-10 pl-6 pr-8 border-l border-teal-200/50 hidden sm:block">
                                     <SimplePieChart data={currentData.fundPieData} />
                                 </div>
                            </div>
                        </div>

                        {/* Middle Section: Cards (Left) & Ranking (Right) */}
                        <div className="lg:col-span-8">
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 h-full">
                                {platformCards.map((card) => {
                                    const val = currentData.totals[card.key] || 0;
                                    return (
                                        <div key={card.key} className={`bg-white border rounded-2xl p-4 shadow-sm hover:shadow-md transition-all flex flex-col h-full min-h-[140px] ${card.border}`}>
                                            <div className="mb-3">
                                                <div className="flex items-center justify-between mb-3">
                                                    <div className="flex items-center space-x-2">
                                                        <div className={`p-2.5 rounded-xl ${card.bg}`}>
                                                            <card.icon size={18} className={card.color} />
                                                        </div>
                                                        <span className="text-sm font-semibold text-slate-600">{card.title}</span>
                                                    </div>
                                                </div>
                                                <h4 className="text-xl font-bold text-slate-800 ml-1">{val.toLocaleString()}</h4>
                                            </div>
                                            
                                            <div className="mt-auto pt-3 border-t border-slate-50 space-y-1.5">
                                                 {card.items && card.items.length > 0 ? (
                                                     card.items.slice(0, 3).map((item, idx) => (
                                                        <div key={idx} className="flex justify-between items-center text-[11px] text-slate-500">
                                                            <span className="truncate w-2/3" title={item.name}>{item.name}</span>
                                                            <span className="font-medium text-slate-700">{item.value.toLocaleString()}</span>
                                                        </div>
                                                     ))
                                                 ) : (
                                                     <div className="text-[10px] text-slate-400">ไม่มีข้อมูล</div>
                                                 )}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>

                        <div className="lg:col-span-4 flex flex-col">
                            <div className="bg-white border border-slate-100 rounded-2xl flex flex-col shadow-sm h-full max-h-[480px]">
                                <div className="p-5 border-b border-slate-50 flex items-center justify-between shrink-0 bg-slate-50/50 rounded-t-2xl">
                                    <h3 className="font-bold text-slate-700 flex items-center">
                                        <Trophy className="mr-2 text-amber-400" size={18} />
                                        อันดับยอดเบิก <span className="text-xs text-teal-600 ml-2 font-bold">{selectedFundName}</span>
                                    </h3>
                                </div>
                                
                                <div className="p-3 space-y-2 overflow-y-auto custom-scrollbar flex-1">
                                    {topHospitals.map((hospital, index) => {
                                        const colorClass = rankColors[index % rankColors.length];
                                        return (
                                            <div key={index} className="flex items-center p-3 rounded-xl bg-white border border-slate-100 hover:border-teal-100 hover:shadow-sm transition-all group">
                                                <div className={`w-8 h-8 rounded-lg flex items-center justify-center font-bold text-xs mr-3 shrink-0 border ${colorClass}`}>
                                                    {index + 1}
                                                </div>
                                                <div className="flex-1 grid grid-cols-2 gap-2">
                                                     <div className="text-xs text-slate-500 flex flex-col justify-center">
                                                         <span className="font-medium text-slate-600 text-sm group-hover:text-teal-600 transition-colors truncate">
                                                             {hospital.name.replace('รพ.สต.', '').replace('บ้าน', '')}
                                                         </span>
                                                     </div>
                                                     <div className="text-right flex flex-col justify-center">
                                                         <span className="font-bold text-slate-800 text-sm">{hospital.value.toLocaleString()}</span>
                                                         <span className="text-[10px] text-slate-400">บาท</span>
                                                     </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>

                        {/* Bottom Section: Medical Line Chart */}
                        <div className="lg:col-span-12">
                            <div className="bg-white border border-slate-100 rounded-2xl p-6 shadow-sm relative overflow-hidden">
                                <div className="flex items-center justify-between mb-4 relative z-10">
                                    <div>
                                        <h3 className="font-bold flex items-center text-lg text-slate-700">
                                            <TrendingUp size={22} className="mr-2 text-teal-500" />
                                            แนวโน้มการเบิกจ่ายรายเดือน
                                        </h3>
                                        <p className="text-xs text-slate-400 mt-1 ml-8 font-medium">
                                            <span className="bg-slate-100 px-2 py-0.5 rounded text-slate-600">{selectedHospitalName}</span> 
                                            <span className="mx-2 text-slate-300">•</span> 
                                            <span className="bg-slate-100 px-2 py-0.5 rounded text-slate-600">{selectedPlatformName}</span>
                                        </p>
                                    </div>
                                </div>
                                <MedicalLineChart data2568={trendData["2568"]} data2569={trendData["2569"]} />
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
    </>
  );
}